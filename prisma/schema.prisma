generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  name         String?
  password     String
  rating       Float         @default(4.5) // Mock rating for demo
  isVerified   Boolean       @default(false)
  vehicles     Vehicle[]
  trips        Trip[]
  messages     Message[]
  chatMembers  ChatMember[]
  tripRequests TripRequest[]
  payments     Payment[]
  createdAt    DateTime      @default(now())
}

model Vehicle {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  type         VehicleType
  brand        String
  model        String
  seatCount    Int
  licensePlate String?
  trips        Trip[]
  createdAt    DateTime @default(now())

  @@index([userId])
}

enum VehicleType {
  CAR
  MOTORCYCLE
  VAN
}

model Trip {
  id             String        @id @default(cuid())
  from           String        // Keep existing field name
  to             String        // Keep existing field name
  date           DateTime      // Keep existing field name
  price          Float
  totalSeats     Int           @default(0)
  availableSeats Int           @default(0)
  description    String?
  isFull         Boolean       @default(false)
  userId         String
  vehicleId      String
  user           User          @relation(fields: [userId], references: [id])
  vehicle        Vehicle       @relation(fields: [vehicleId], references: [id])
  createdAt      DateTime      @default(now())
  chat           Chat?
  requests       TripRequest[]
  payments       Payment[]

  @@index([userId])
  @@index([vehicleId])
  @@index([from])
  @@index([to])
  @@index([date])
}

model Chat {
  id        String       @id @default(cuid())
  tripId    String       @unique
  createdAt DateTime     @default(now())

  trip      Trip         @relation(fields: [tripId], references: [id], onDelete: Cascade)
  messages  Message[]
  members   ChatMember[]
}

model Message {
  id          String      @id @default(cuid())
  chatId      String
  senderId    String
  content     String
  messageType MessageType @default(TEXT)
  metadata    Json?
  createdAt   DateTime    @default(now())

  chat   Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User @relation(fields: [senderId], references: [id])

  @@index([chatId])
  @@index([senderId])
}

enum MessageType {
  TEXT
  IMAGE
  LOCATION
}

model ChatMember {
  id        String   @id @default(cuid())
  chatId    String
  userId    String
  joinedAt  DateTime @default(now())

  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  @@unique([chatId, userId])
  @@index([userId])
}

model TripRequest {
  id             String        @id @default(cuid())
  tripId         String
  requesterId    String
  type           RequestType
  status         RequestStatus @default(PENDING)
  seatsRequested Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  trip      Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  requester User      @relation(fields: [requesterId], references: [id])
  payments  Payment[]

  @@unique([tripId, requesterId, type, status])
  @@index([tripId])
  @@index([requesterId])
  @@index([status])
}

enum RequestType {
  BOOKING
  CHAT
}

enum RequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

model Payment {
  id          String        @id @default(cuid())
  tripId      String
  payerId     String
  requestId   String?
  amount      Float
  status      PaymentStatus @default(NOT_STARTED)
  providerRef String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  trip    Trip         @relation(fields: [tripId], references: [id])
  payer   User         @relation(fields: [payerId], references: [id])
  request TripRequest? @relation(fields: [requestId], references: [id])

  @@index([tripId])
  @@index([payerId])
  @@index([requestId])
}

enum PaymentStatus {
  NOT_STARTED
  STARTED
  PAID
  FAILED
  REFUNDED
}
